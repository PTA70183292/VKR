version: '3.8'                                         # Указываем версию спецификации Docker Compose для совместимости с современными движками.

services:                                              # Объявляем список всех микросервисов, входящих в архитектуру приложения.

  # 1. Сервис Базы Данных (PostgreSQL)
  db:
    image: postgres:15                                 # Загружаем официальный образ PostgreSQL версии 15 из Docker Hub для стабильной работы.
    container_name: db                                 # Фиксируем DNS-имя контейнера, чтобы к нему можно было обращаться по адресу "db".
    restart: always                                    # Задаем политику перезапуска: контейнер поднимется сам при падении или рестарте демона.
    environment:                                       # Начинаем блок переменных окружения для первоначальной конфигурации базы данных.
      - POSTGRES_USER=${POSTGRES_USER}                 # Имя суперпользователя базы данных при первой инициализации тома.
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}         # Пароль суперпользователя базы данных.
      - POSTGRES_DB=${POSTGRES_DB}                     # Имя создаваемой базы данных по умолчанию.
    ports:                                             # Настраиваем проброс сетевых портов между хост-машиной и контейнером.
      - "5432:5432"                                    # Открываем доступ к порту 5432 снаружи для подключения административных утилит (DBeaver).
    volumes:                                           # Настраиваем монтирование постоянных хранилищ для сохранения данных.
      - postgres_data:/var/lib/postgresql/data         # Монтируем именованный том в системную директорию Postgres для сохранения данных.

  # 2. Сервис Бэкенда (FastAPI)
  backend:
    build: ./backend                                   # Собираем Docker-образ из исходного кода, используя Dockerfile в папке ./backend.
    container_name: backend                            # Задаем имя контейнера для удобного обращения к API из других сервисов.
    restart: always                                    # Гарантируем, что API сервер перезапустится автоматически в случае критической ошибки.
    ports:                                             # Пробрасываем порты для доступа к API или документации Swagger.
      - "8000:8000"                                    # Связываем порт 8000 хоста с портом 8000 контейнера, где запущен uvicorn.
    depends_on:                                        # Определяем порядок запуска: этот сервис начнет старт только после инициализации сервиса db.
      - db                                             # Указываем явную зависимость от контейнера базы данных.
    env_file: .env                                     # Загружаем остальные переменные окружения из файла .env (ключи API, настройки БД).
    volumes:                                           # Настраиваем тома для кэширования и горячей перезагрузки кода.
      - ./backend:/app                                 # Пробрасываем локальную папку с кодом внутрь контейнера для разработки (Hot Reload).
      - hf_cache:/root/.cache/huggingface              # Используем отдельный том для весов моделей, чтобы не скачивать их заново при каждом рестарте.
    
    
    # [ВАРИАНТ 1 только инференс: ДЛЯ VPS / CPU] (Закомментирован)
    #environment:                                      # Переменные окружения, специфичные для запуска модели.
      #- INFERENCE_DEVICE=cpu                        
      
      # [ВАРИАНТ 2 инференс + дообучение: ДЛЯ ЛОКАЛЬНОЙ МАШИНЫ С GPU] (Включен) 
    deploy:                                           # Секция развертывания, управляющая ресурсами контейнера.
      resources:                                     # Определение физических ограничений и квот.
        reservations:                                # Бронирование специфического оборудования.
          devices:                                   # Список требуемых устройств.
            - driver: nvidia                         # Указываем, что требуется драйвер NVIDIA (должен быть установлен NVIDIA Container Toolkit).
              count: 1                               # Запрашиваем доступ к 1 видеокарте.
              capabilities: [gpu]                    # Разрешаем контейнеру использовать GPU-вычисления.


  # 3. Сервис Фронтенда (Streamlit - Admin)
  frontend:
    build: ./frontend                                  # Собираем образ для интерфейса университета
    container_name: frontend_admin                     # Даем уникальное имя контейнеру админ-панели во избежание конфликтов.
    restart: always                                    # Обеспечиваем постоянную доступность веб-интерфейса.
    ports:                                             # Настраиваем внешний доступ к веб-интерфейсу.
      - "8501:8501"                                    # Пробрасываем стандартный порт Streamlit 8501 один к одному на хост.
    depends_on:                                        # Указываем, что фронтенд должен запускаться после бэкенда.
      - backend                                        # Ждем доступности контейнера backend перед стартом.
    environment:                                       # Настраиваем переменные среды для связи с API.
      - BACKEND_URL=http://backend:8000                # Указываем внутрисетевой адрес API для отправки запросов.

  # 4. Сервис Фронтенда (Streamlit - Student)
  frontend-student:
    build: ./frontend_student                          # Собираем образ для студенческого интерфейса.
    container_name: frontend_student                   # Задаем фиксированное имя для второго фронтенд-сервиса.
    restart: always                                    # Поддерживаем сервис в рабочем состоянии автоматически.
    ports:                                             # Настраиваем доступ к студенческому интерфейсу на другом порту.
      - "8502:8501"                                    # Перенаправляем внешний порт 8502 на внутренний порт 8501 контейнера.
    environment:                                       # Конфигурируем точку входа API для этого инстанса.
      - BACKEND_URL=http://backend:8000                # Используем тот же бэкенд, обращаясь к нему по внутреннему имени.
    depends_on:                                        # Устанавливаем зависимость запуска от основного API.
      - backend                                        # Гарантируем наличие сервиса backend перед стартом интерфейса.

volumes:                                               # Объявляем глобальные именованные тома, используемые в сервисах.
  postgres_data:                                       # Создаем том для хранения файлов БД PostgreSQL вне файловой системы контейнеров.
  hf_cache:                                            # Создаем том для хранения кэша Hugging Face Hub (модели и токенизаторы).
